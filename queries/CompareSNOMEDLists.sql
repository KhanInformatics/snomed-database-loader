USE SNOMEDCT;
GO

-- Compare two lists of SNOMED codes to find differences
-- List 1: Codes from checkcodes.txt file
-- List 2: Codes provided by user

-- Create temporary tables for both lists
IF OBJECT_ID('tempdb..#List1') IS NOT NULL DROP TABLE #List1;
IF OBJECT_ID('tempdb..#List2') IS NOT NULL DROP TABLE #List2;

-- List 1: Load from checkcodes.txt file
CREATE TABLE #List1 (ConceptId NVARCHAR(18));
BULK INSERT #List1
FROM 'o:\GitHub\snomed-database-loader\Queries\checkcodes.txt'
WITH (FIELDTERMINATOR = '\n', ROWTERMINATOR = '\n', FIRSTROW = 1);

-- Clean List 1
DELETE FROM #List1 WHERE ConceptId IS NULL OR LTRIM(RTRIM(ConceptId)) = '';
UPDATE #List1 SET ConceptId = LTRIM(RTRIM(ConceptId));

-- List 2: User provided list
CREATE TABLE #List2 (ConceptId NVARCHAR(18));
INSERT INTO #List2 (ConceptId) VALUES
('8517006'),('27113001'),('60621009'),('61086009'),('75367002'),('77176002'),
('118582008'),('118586006'),('133932002'),('160603005'),('160604004'),('160605003'),
('160606002'),('160616005'),('160617001'),('183073003'),('225323000'),('228958009'),
('230056004'),('248333004'),('258672001'),('258683005'),('258813002'),('258896009'),
('258983007'),('259018001'),('266895004'),('266919005'),('266920004'),('266921000'),
('266922007'),('266923002'),('266924008'),('271636001'),('275122004'),('275932007'),
('312856000'),('364075005'),('401067009'),('401122004'),('722499006'),('763256006'),
('763726001'),('767524001'),('92421000000102'),('366121000000108'),('366171000000107'),
('366211000000105'),('366241000000106'),('506171000000109'),('523221000000100'),
('523241000000107'),('715851000000102'),('717121000000105'),('824421000000101'),
('840391000000101'),('853681000000104'),('863521000000106'),('871641000000105'),
('871661000000106'),('976631000000101'),('976651000000108'),('976671000000104'),
('976691000000100'),('976731000000106'),('976751000000104'),('976771000000108'),
('976791000000107'),('976811000000108'),('976831000000100'),('976851000000107'),
('976871000000103'),('976891000000104'),('976911000000101'),('976931000000109'),
('976951000000102'),('976971000000106'),('1005681000000107'),('1025301000000100'),
('1025321000000109'),('1028551000000102'),('1082641000000106'),('1085871000000105'),
('1098881000000103'),('1326201000000101'),('10692611000001105');

-- Find codes in List1 but NOT in List2 (codes that were removed)
PRINT '=== CODES IN CHECKCODES.TXT BUT NOT IN YOUR LIST (REMOVED) ===';
SELECT DISTINCT l1.ConceptId AS 'Codes Removed'
FROM #List1 l1
LEFT JOIN #List2 l2 ON l1.ConceptId = l2.ConceptId
WHERE l2.ConceptId IS NULL
ORDER BY l1.ConceptId;

-- Find codes in List2 but NOT in List1 (codes that were added)
PRINT '';
PRINT '=== CODES IN YOUR LIST BUT NOT IN CHECKCODES.TXT (ADDED) ===';
SELECT DISTINCT l2.ConceptId AS 'Codes Added'
FROM #List2 l2
LEFT JOIN #List1 l1 ON l2.ConceptId = l1.ConceptId
WHERE l1.ConceptId IS NULL
ORDER BY l2.ConceptId;

-- Summary counts
PRINT '';
PRINT '=== SUMMARY ===';
SELECT 
    (SELECT COUNT(DISTINCT ConceptId) FROM #List1) AS 'Total in checkcodes.txt',
    (SELECT COUNT(DISTINCT ConceptId) FROM #List2) AS 'Total in your list',
    (SELECT COUNT(DISTINCT l1.ConceptId) FROM #List1 l1 LEFT JOIN #List2 l2 ON l1.ConceptId = l2.ConceptId WHERE l2.ConceptId IS NULL) AS 'Codes Removed',
    (SELECT COUNT(DISTINCT l2.ConceptId) FROM #List2 l2 LEFT JOIN #List1 l1 ON l2.ConceptId = l1.ConceptId WHERE l1.ConceptId IS NULL) AS 'Codes Added';

-- Clean up
DROP TABLE #List1;
DROP TABLE #List2;
